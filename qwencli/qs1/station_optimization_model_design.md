# 站点布局与容量配置优化模型设计

为了解决“最大化用户借还成功率”和“最小化运营成本”这两个目标，我们可以将其构建为一个**多目标混合整数线性规划 (MILP)** 问题。

## 1. 问题定义与目标

我们需要决定：
*   每个站点 $i$ 的保留状态 $x_i$ (1: 保留, 0: 关闭)。
*   每个保留站点 $i$ 的容量配置 $c_i$ (一个正整数)。

### 目标函数

这是一个多目标优化问题，需要同时优化两个相互冲突的目标。我们采用**加权求和法**将其转化为单目标优化问题。

**目标函数 (最小化):**
```
总成本 = W1 * (1 - 借还成功率) + W2 * (调度成本 + 空置损失)
```
其中，$W1$ 和 $W2$ 是用户设定的权重，用于平衡两个目标的重要程度。为简化，可以先令 $W1 = W2 = 1$，或根据业务需求调整。

#### 1.1 借还成功率最大化 (等价于最小化 (1 - 借还成功率))

假设我们有对未来一段时间（例如一天）内每个站点 $i$ 的**净需求** $d_i$ 的预测。$d_i > 0$ 表示该站点净需求为借车，$d_i < 0$ 表示净需求为还车。

为了量化“成功率”，我们定义一个站点的**服务水平 (Service Level)**。一个简单的模型是假设如果一个站点在一天开始时有 $c_i$ 个车位，那么它可以满足其净需求 $d_i$ 的程度。

一个更精确的模型是考虑**借车失败率**和**还车失败率**。
*   **借车失败**: 当用户想借车但站点无车时发生。失败次数与 $\max(0, d_i)$ 和站点容量 $c_i$ 相关。
*   **还车失败**: 当用户想还车但站点无空位时发生。失败次数与 $\max(0, -d_i)$ 和站点容量 $c_i$ 相关。

我们可以定义：
*   $借车需求_i = \max(d_i, 0)$
*   $还车需求_i = \max(-d_i, 0)$

一个简化的失败次数估计：
*   $借车失败次数_i \approx \max(0, 借车需求_i - (当前车数 + 还车需求_i))$ （假设初始车数为0的最坏情况）
*   $还车失败次数_i \approx \max(0, 还车需求_i - (容量 - 借车需求_i))$ （假设初始车数为容量的最坏情况）

但这过于简化且不准确。更合理的做法是引入**期望的未满足借车数量**和**期望的未满足还车数量**。

**更精确的模型:**

为了解决这个问题，我们引入一个**随机性**的概念。假设 $D_i$ 是站点 $i$ 的随机净需求，其预测均值为 $d_i$。我们可以假设 $D_i$ 服从某种分布（例如正态分布或泊松分布）。

站点 $i$ 的**期望未满足借车数量 (Expected Unsatisfied Demand for Borrowing)** $EUB_i$ 和 **期望未满足还车数量 (Expected Unsatisfied Demand for Returning)** $EUR_i$ 可以近似计算，但这通常需要复杂的积分或仿真。

为了使模型可解，我们采用一种线性化的近似方法。

**线性化近似:**

我们定义一个站点的“服务水平”为 1 减去“失败率”。失败率可以近似为未满足需求与总需求的比例。

一种简化但常用的方法是将目标函数直接定义为与容量配置相关的“失败惩罚”。

**最终采用的目标函数 (最小化):**

我们不直接优化“成功率”，而是最小化与“容量不足”相关的“惩罚”。

目标函数:
```
Minimize: α * Σ(i ∈ 所有站点) max(0, d_i - s_i * c_i) + β * Σ(i ∈ 所有站点) max(0, -d_i - (1 - s_i) * c_i) + γ * Σ(i ∈ 所有站点) x_i * F(c_i) + δ * Σ(i ∈ 所有站点) max(0, s_i * c_i - d_i) + max(0, (1 - s_i) * c_i + d_i)
```

这个公式非常复杂。让我们回到最初的目标。

**回到原始目标的清晰定义:**

*   **目标1：最大化用户借还成功率 (Minimize 1 - 成功率)**
    *   假设预测需求 $d_i$ 是净流入量。
    *   对于站点 $i$，如果分配容量 $c_i$，则理论上可以满足 $[-c_i, c_i]$ 范围内的净流入。
    *   **失败**定义为 $|d_i| > c_i$。
    *   一个合理的“失败度量”是 $max(0, |d_i| - c_i)$。
    *   为了使模型可线性化，我们使用 $max(0, d_i - c_i) + max(0, -d_i - c_i)$ 作为站点 $i$ 的失败惩罚。
    *   总失败惩罚 $P_{failure} = \sum_{i} (max(0, d_i - c_i) + max(0, -d_i - c_i))$
    *   为了与成本量纲一致，可以将其视为一种“失败成本”。我们的目标是最小化这个失败成本。
    *   因此，目标1可以转化为最小化 $P_{failure}$。

*   **目标2：最小化运营成本**
    *   **调度成本** = $\sum_{i} |借还差值_i|$。这里的“借还差值”通常指一天结束时站点的净变化量，即 $d_i$（如果 $d_i$ 本身就是净变化）。所以调度成本 = $\sum_{i} |d_i|$。但这个值是固定的，由需求决定，与我们的决策变量 $c_i$ 和 $x_i$ 无关。因此，直接最小化调度成本没有意义。
    *   更合理的解释是，调度成本与站点的**不平衡程度**有关，即 $|当前车数 + d_i - 理想平衡车数|$。但这仍然复杂。
    *   一个更常见的模型是将调度成本与站点的**容量**或**活动水平**挂钩。例如，$Cost_{调度, i} = K_{调度} \cdot x_i$ 或 $Cost_{调度, i} = K_{调度} \cdot c_i$。但这与题目描述不符。
    *   **重新理解题目**: "调度成本 ＝ 各站借还差值的约数"。这可能意味着 $Cost_{调度} = \sum_{i} K_i \cdot |d_i|$，其中 $K_i$ 是一个与站点 $i$ 相关的系数，例如是否开放 ($x_i$)。如果是这样，$Cost_{调度} = \sum_{i} K_{调度} \cdot x_i \cdot |d_i|$。
    *   **空置损失** = $\sum_{i} (预测需求 - 分配容量)^2$。这个公式本身有问题，因为 $(d_i - c_i)^2$ 在 $d_i > c_i$ 时会惩罚容量过大，在 $d_i < c_i$ 时也会惩罚容量过大，这与“空置损失”（通常指容量未被充分利用）的直觉不符。
    *   一个更符合“空置损失”概念的定义是 $\sum_{i} max(0, c_i - |d_i|)^2$ 或者简化为 $\sum_{i} max(0, c_i - |d_i|)$。
    *   但题目明确给出公式，我们暂时按其字面意思理解。

    因此，目标2为：
    ```
    Minimize: Cost_{运营} = Cost_{调度} + Cost_{空置}
             = \sum_{i} (K_{调度} \cdot x_i \cdot |d_i|) + \sum_{i} (d_i - c_i)^2
    ```
    为了简化，假设 $K_{调度} = 1$。
    ```
    Minimize: Cost_{运营} = \sum_{i} (x_i \cdot |d_i|) + \sum_{i} (d_i - c_i)^2
    ```

**综合目标函数 (最小化):**
```
Objective = W1 * \sum_{i} (max(0, d_i - c_i) + max(0, -d_i - c_i)) + W2 * (\sum_{i} (x_i \cdot |d_i|) + \sum_{i} (d_i - c_i)^2)
```

为简化，令 $W1 = W2 = 1$。

```
Minimize: Z = \sum_{i} (max(0, d_i - c_i) + max(0, -d_i - c_i)) + \sum_{i} (x_i \cdot |d_i|) + \sum_{i} (d_i - c_i)^2
```

### 决策变量

*   $x_i \in \{0, 1\}$: 站点 $i$ 是否保留。
*   $c_i \in \mathbb{Z}^+$: 站点 $i$ 的容量配置 (如果 $x_i = 1$)。为避免无界，需要设定一个最大容量 $C_{max}$。
*   $y_i^+ = max(0, d_i - c_i)$: 站点 $i$ 的借车失败惩罚 (辅助变量)。
*   $y_i^- = max(0, -d_i - c_i)$: 站点 $i$ 的还车失败惩罚 (辅助变量)。

### 约束条件

1.  **容量与站点状态的关系:**
    *   $c_i \leq C_{max} \cdot x_i$ 对所有站点 $i$。这确保了如果站点关闭 ($x_i = 0$)，则容量 $c_i$ 必须为 0。如果站点开放 ($x_i = 1$)，容量最多为 $C_{max}$。
    *   $c_i \geq C_{min} \cdot x_i$ 对所有站点 $i$。这确保了如果站点开放，则容量至少为 $C_{min}$。
    *   $c_i \in \mathbb{Z}^+$, $x_i \in \{0, 1\}$

2.  **线性化 $max$ 函数 (Big-M 方法):**
    *   $y_i^+ \geq d_i - c_i$
    *   $y_i^+ \geq 0$
    *   $y_i^+ \leq d_i - c_i + M \cdot (1 - z_i^+)$ （其中 $z_i^+$ 是一个辅助的0-1变量，当 $d_i > c_i$ 时为1）
    *   $y_i^+ \leq M \cdot z_i^+$
    *   这种方法对于每个 $max$ 函数都需要引入辅助的0-1变量，会使模型变得非常复杂。
    
    **更简单的线性化方法 (适用于目标函数中的 $max$):**
    *   由于 $y_i^+$ 和 $y_i^-$ 只在目标函数中以最小化形式出现，并且它们的系数为正，最优解时必然有 $y_i^+ = max(0, d_i - c_i)$ 和 $y_i^- = max(0, -d_i - c_i)$。
    *   因此，我们只需在模型中添加约束：
        *   $y_i^+ \geq d_i - c_i$
        *   $y_i^+ \geq 0$
        *   $y_i^- \geq -d_i - c_i$
        *   $y_i^- \geq 0$

### 最终数学模型

**Minimize:**
```
Z = \sum_{i} (y_i^+ + y_i^-) + \sum_{i} (x_i \cdot |d_i|) + \sum_{i} (d_i - c_i)^2
```

**Subject to:**
```
c_i \leq C_{max} \cdot x_i          ∀i
c_i \geq C_{min} \cdot x_i          ∀i
y_i^+ \geq d_i - c_i                ∀i
y_i^+ \geq 0                        ∀i
y_i^- \geq -d_i - c_i               ∀i
y_i^- \geq 0                        ∀i

c_i \in \mathbb{Z}^+                ∀i
x_i \in \{0, 1\}                    ∀i
y_i^+, y_i^- \in \mathbb{R}^+       ∀i
```

**注意:**
*   目标函数中的 $\sum_{i} (d_i - c_i)^2$ 项是非线性的。这使得问题成为一个**混合整数二次规划 (MIQP)** 问题。
*   为了解决这个问题，我们可以：
    1.  **线性化**: 引入新的变量和约束来近似这个二次项。但这通常很复杂。
    2.  **使用支持MIQP的求解器**: 例如 Gurobi, CPLEX。它们可以直接处理这种形式的目标函数。
    3.  **分解目标**: 将问题分解为两个子问题，分别优化两个目标，然后寻找帕累托前沿。

**模型简化与实现建议:**

考虑到实现的复杂性，我们可以对模型进行一些简化：

1.  **移除非线性项**: 忽略 $(d_i - c_i)^2$ 项，或者将其替换为一个线性近似，例如 $max(0, |d_i| - c_i)$ 或 $max(0, c_i - |d_i|)$。
2.  **权重调整**: 通过调整 $W1$ 和 $W2$ 来平衡不同目标的重要性。
3.  **分步优化**: 先固定一部分变量（例如，先决定哪些站点保留），再优化另一部分（例如，容量配置）。

**下一步:**

基于以上模型设计，下一步是：
1.  **数据准备**: 获取或生成站点的预测需求数据 $d_i$。
2.  **模型实现**: 使用 Python (PuLP, Pyomo) 或专门的优化求解器 API (如 Gurobi Python API) 来实现这个模型。
3.  **求解**: 使用合适的求解器（如 CBC, Gurobi, CPLEX）来求解模型。
4.  **结果输出**: 将结果写入 `result1_1.xlsx` 和 `result1_2.xlsx`。