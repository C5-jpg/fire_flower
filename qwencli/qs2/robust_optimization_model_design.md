# 问题二：鲁棒优化模型设计

## 1. 问题回顾与目标

在问题一中，我们构建了一个确定性的优化模型，目标是同时最大化用户借还成功率和最小化运营成本。该模型基于对未来的点预测（如每个站点的净需求 $d_i$）。

然而，实际运营中存在诸多不确定性，例如：
- **需求波动**: 用户需求可能因天气、事件等因素而偏离预测值。
- **成本变化**: 运营成本（如调度成本、建设成本）可能因市场因素而上涨。
- **外部影响**: 如地铁开通可能显著改变某些区域的出行需求。

鲁棒优化（Robust Optimization）旨在寻找一个解决方案，该方案在所有可能的不确定性情景（在预定义的不确定性集合内）下都能表现良好，特别是关注“最坏情况”下的性能。

本问题的目标是：
1.  在问题一模型的基础上，引入不确定性集合。
2.  构建一个鲁棒优化模型，使方案在最坏情况下依然表现良好。
3.  分析并量化以下不确定性因素的影响：
    - 需求波动 (`±10%~15%`)
    - 成本上涨 (`+5%`)
    - 地铁影响 (`-15%~25%`)

## 2. 不确定性建模

### 2.1. 不确定性因素定义

我们将问题一中的主要参数视为不确定变量：

- $\tilde{d}_i$: 站点 $i$ 的**实际（不确定）净需求**。
- $\tilde{c}_i$: 站点 $i$ 的**实际（不确定）容量** (决策变量，但其成本或效果可能受不确定性影响)。
- $\tilde{K}_{调度,i}$: 站点 $i$ 的**实际（不确定）调度成本系数**。

### 2.2. 不确定性集合 (Uncertainty Set) $\mathcal{U}$

我们需要定义一个集合 $\mathcal{U}$，它包含了所有可能的不确定性参数组合 $(\tilde{d}, \tilde{K}_{调度})$。

根据题目要求，我们考虑以下不确定性来源：

#### a. 需求波动 (`±10%~15%`)

对于每个站点 $i$ 的预测需求 $d_i$，实际需求 $\tilde{d}_i$ 可能在一个区间内波动。

$$
\tilde{d}_i \in [d_i \cdot (1 - \Delta_{demand}), d_i \cdot (1 + \Delta_{demand})]
$$

其中，$\Delta_{demand}$ 是波动率。题目给出 `±10%~15%`，我们可以取一个保守的估计，例如 $\Delta_{demand} = 0.15$。

为了更精确地建模，可以区分正负需求的波动，但这会增加模型复杂度。我们暂时采用对称区间。

#### b. 成本上涨 (`+5%`)

这里的“成本上涨”可能指的是调度成本系数 $K_{调度,i}$ 的增加。

$$
\tilde{K}_{调度,i} \in [K_{调度,i}, K_{调度,i} \cdot (1 + \Delta_{cost})]
$$

其中，$\Delta_{cost} = 0.05$。

#### c. 地铁影响 (`-15%~25%`)

“地铁影响”对需求 $\tilde{d}_i$ 产生作用。这可以理解为在原有需求波动基础上，再叠加一个由地铁带来的影响因子。

一种建模方式是将地铁影响视为对预测需求 $d_i$ 的一个额外乘法因子 $\theta_i$：

$$
\tilde{d}_i = d_i \cdot (1 + \theta_i)
$$

其中，$\theta_i \in [-0.15, 0.25]$。

**不确定性集合 $\mathcal{U}$ 的最终形式**:

综合以上因素，对于每个站点 $i$，实际需求 $\tilde{d}_i$ 的不确定性可以表示为：

$$
\tilde{d}_i = d_i \cdot (1 + \delta_i) \cdot (1 + \theta_i)
$$

其中，
- $\delta_i \in [-\Delta_{demand}, \Delta_{demand}] = [-0.15, 0.15]$
- $\theta_i \in [-0.15, 0.25]$

或者，为了简化，可以将两者合并为一个总的波动区间：

$$
\tilde{d}_i \in [d_i \cdot (1 - 0.15) \cdot (1 - 0.15), d_i \cdot (1 + 0.15) \cdot (1 + 0.25)] \\
= [d_i \cdot 0.7225, d_i \cdot 1.4375]
$$

但这可能过于保守。更合理的做法是将它们作为独立的不确定性来源，即：

$$
\tilde{d}_i \in \{ d_i \cdot (1 + \delta_i) \cdot (1 + \theta_i) \,|\, \delta_i \in [-0.15, 0.15], \theta_i \in [-0.15, 0.25] \}
$$

对于调度成本系数：

$$
\tilde{K}_{调度,i} \in [K_{调度,i}, K_{调度,i} \cdot 1.05]
$$

**定义不确定性集合 $\mathcal{U}$**:

$$
\mathcal{U} = \{ (\tilde{d}, \tilde{K}_{调度}) \,|\, \tilde{d}_i = d_i \cdot (1 + \delta_i) \cdot (1 + \theta_i), \tilde{K}_{调度,i} \in [K_{调度,i}, K_{调度,i} \cdot 1.05], \forall i \}
$$

其中，$\delta_i \in [-0.15, 0.15], \theta_i \in [-0.15, 0.25]$。

## 3. 鲁棒优化模型构建

### 3.1. 原始问题一的目标函数 (回顾)

最小化 (简化版，忽略部分项):
$$
Z = \sum_{i} (max(0, d_i - c_i) + max(0, -d_i - c_i)) + \sum_{i} (x_i \cdot K_{调度,i} \cdot |d_i|)
$$

### 3.2. 鲁棒优化目标

鲁棒优化的目标是最小化**最坏情况下的成本**。即，寻找最优决策 $(x, c)$，使得在不确定性集合 $\mathcal{U}$ 内的所有情景中，目标函数值的最大值最小。

$$
\min_{x, c} \max_{(\tilde{d}, \tilde{K}_{调度}) \in \mathcal{U}} \left( \sum_{i} (max(0, \tilde{d}_i - c_i) + max(0, -\tilde{d}_i - c_i)) + \sum_{i} (x_i \cdot \tilde{K}_{调度,i} \cdot |\tilde{d}_i|) \right)
$$

这是一个典型的 **Min-Max** 鲁棒优化问题。

### 3.3. 约束条件

决策变量的约束与问题一相同：
- $c_i \leq C_{max} \cdot x_i$
- $c_i \geq C_{min} \cdot x_i$
- $c_i \in \mathbb{Z}^+$
- $x_i \in \{0, 1\}$

## 4. 模型求解策略

直接求解这个 Min-Max 问题非常困难，特别是内部的 Max 问题涉及 $max$ 函数和不确定变量的乘积。我们需要对其进行转化或近似。

### 4.1. 方法一：列约束生成法 (Column-and-Constraint Generation, CCG)

这是一种迭代算法，适用于两阶段鲁棒优化问题。
1.  **主问题 (Master Problem)**: 给定一个候选解 $(x, c)$，寻找使目标函数最大的不确定性情景 $(\tilde{d}, \tilde{K}_{调度})$。
2.  **子问题 (Subproblem)**: 给定最坏情况的不确定性 $(\tilde{d}, \tilde{K}_{调度})$，评估当前解 $(x, c)$ 的成本，并生成割平面（约束）添加到主问题中。
3.  迭代直到收敛。

### 4.2. 方法二：对偶化内部 Max 问题

尝试将内部的 Max 问题转化为一个等价的优化问题，然后与外部的 Min 问题合并。

考虑内部 Max 问题的一部分：
$$
\max_{(\tilde{d}, \tilde{K}_{调度}) \in \mathcal{U}} \sum_{i} (x_i \cdot \tilde{K}_{调度,i} \cdot |\tilde{d}_i|)
$$

由于 $\tilde{K}_{调度,i}$ 和 $|\tilde{d}_i|$ 都在各自的区间内，且 $x_i$ 是0-1变量，最大化这个乘积很容易：
- 如果 $x_i = 1$，则 $\tilde{K}_{调度,i}$ 取上界 $K_{调度,i} \cdot 1.05$，$|\tilde{d}_i|$ 也取其上界。
- 如果 $x_i = 0$，则该项为0。

对于 $\sum_{i} (max(0, \tilde{d}_i - c_i) + max(0, -\tilde{d}_i - c_i))$ 部分，最大化则更为复杂，因为它涉及到 $max$ 函数。

### 4.3. 方法三：引入辅助变量并使用对偶原理

我们可以为内部 Max 问题引入辅助变量，并利用强对偶性将其转化为一个等价的单层优化问题。但这通常需要拉格朗日乘子和对偶变量，对于包含 $max$ 函数和离散变量的问题，过程会非常复杂。

### 4.4. 方法四：场景近似 (Scenario Approximation)

生成不确定性集合 $\mathcal{U}$ 内的多个具体场景（例如，通过蒙特卡洛采样），然后求解一个在所有这些场景下都表现良好的解。这会将鲁棒优化问题转化为一个带有大量场景的随机优化问题。

$$
\min_{x, c} \max_{s \in S} \left( \sum_{i} (max(0, \tilde{d}_{i,s} - c_i) + max(0, -\tilde{d}_{i,s} - c_i)) + \sum_{i} (x_i \cdot \tilde{K}_{调度,i,s} \cdot |\tilde{d}_{i,s}|) \right)
$$

其中 $S$ 是场景集合。

## 5. 推荐实施路径

考虑到实现的复杂性和可用工具，推荐以下路径：

1.  **场景近似法**：最容易实现和理解。生成代表性的不确定性场景，然后求解一个带有最坏场景约束的优化问题。
2.  **简化鲁棒模型**：如果场景近似法效果不佳或计算量大，可以考虑简化模型，例如只对最关键的部分（如需求）做鲁棒处理。

## 6. 下一步

- 编写脚本生成不确定性场景。
- 实现基于场景近似的鲁棒优化模型。
- 使用求解器（如PuLP, Pyomo）进行求解。
- 分析鲁棒解与确定性解的差异。